$(document).ready(function(){
	var data_cfh={"ask":{"query":{"q":"[[CFH]]","po":["is_associated_with_disease"]},"results":{"count":1,"items":[{"properties":{"is_associated_with_disease":["Myocardial infarction","Membranoproliferative glomerulonephritis","Thrombocytopenia","Age related macular degeneration","Kidney failure","Hemolytic-uremic syndrome"],"type":{"mTextform":"Human proteins","mUrlform":"Human_proteins","mDbkeyform":"Human_proteins","mUserCaseDBKey":"Human_proteins","mNamespace":14,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":"Category:Human proteins","mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null}},"title":{"mTextform":"Factor H","mUrlform":"Factor_H","mDbkeyform":"Factor_H","mUserCaseDBKey":"Factor_H","mNamespace":0,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":null,"mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null},"uri":"http:\/\/genewikiplus.org\/index.php?title=Factor H"}]},"result":"Success"}};
	var data_pin1={"ask":{"query":{"q":"[[In_gene::PIN1]]","po":["?is associated with disease"]},"results":{"count":3,"items":[{"properties":{"is_associated_with_disease":"Breast cancer","type":{"mTextform":"Is a snp","mUrlform":"Is_a_snp","mDbkeyform":"Is_a_snp","mUserCaseDBKey":"Is_a_snp","mNamespace":14,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":"Category:Is a snp","mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null}},"title":{"mTextform":"Rs2233678","mUrlform":"Rs2233678","mDbkeyform":"Rs2233678","mUserCaseDBKey":"Rs2233678","mNamespace":0,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":null,"mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null},"uri":"http:\/\/genewikiplus.org\/index.php?title=Rs2233678"},{"properties":{"is_associated_with_disease":"Breast cancer","type":{"mTextform":"Is a snp","mUrlform":"Is_a_snp","mDbkeyform":"Is_a_snp","mUserCaseDBKey":"Is_a_snp","mNamespace":14,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":"Category:Is a snp","mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null}},"title":{"mTextform":"Rs2233679","mUrlform":"Rs2233679","mDbkeyform":"Rs2233679","mUserCaseDBKey":"Rs2233679","mNamespace":0,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":null,"mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null},"uri":"http:\/\/genewikiplus.org\/index.php?title=Rs2233679"},{"properties":{"is_associated_with_disease":"Breast cancer","type":{"mTextform":"Is a snp","mUrlform":"Is_a_snp","mDbkeyform":"Is_a_snp","mUserCaseDBKey":"Is_a_snp","mNamespace":14,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":"Category:Is a snp","mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null}},"title":{"mTextform":"Rs2233682","mUrlform":"Rs2233682","mDbkeyform":"Rs2233682","mUserCaseDBKey":"Rs2233682","mNamespace":0,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":null,"mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null},"uri":"http:\/\/genewikiplus.org\/index.php?title=Rs2233682"}]},"result":"Success"}};
	var data_brca2={"ask":{"query":{"q":"[[BRCA2]]","po":["is associated with disease"]},"results":{"count":1,"items":[{"properties":{"is_associated_with_disease":["Hereditary breast ovarian cancer","Hypersensitivity reaction type I disease","Female breast cancer","Brain cancer","Pancreatic cancer","Ovarian cancer","Anemia","Syndrome","Leukemia","Prostate cancer","Melanoma"],"type":{"mTextform":"All articles with dead external links","mUrlform":"All_articles_with_dead_external_links","mDbkeyform":"All_articles_with_dead_external_links","mUserCaseDBKey":"All_articles_with_dead_external_links","mNamespace":14,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":"Category:All articles with dead external links","mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null}},"title":{"mTextform":"BRCA2","mUrlform":"BRCA2","mDbkeyform":"BRCA2","mUserCaseDBKey":"BRCA2","mNamespace":0,"mInterwiki":"","mFragment":"","mArticleID":-1,"mLatestID":false,"mRestrictions":[],"mOldRestrictions":false,"mCascadeRestriction":null,"mCascadingRestrictions":null,"mRestrictionsExpiry":[],"mHasCascadingRestrictions":null,"mCascadeSources":null,"mRestrictionsLoaded":false,"mPrefixedText":null,"mTitleProtection":null,"mDefaultNamespace":0,"mWatched":null,"mLength":-1,"mRedirect":null,"mNotificationTimestamp":[],"mBacklinkCache":null},"uri":"http:\/\/genewikiplus.org\/index.php?title=BRCA2"}]},"result":"Success"}};
	var data=data_brca2;
	/*$.getJSON("http://rest.bioontology.org/bioportal/concepts/47670?conceptid=DOID:6846&maxnumchildren=12&apikey=3777d491-e0f2-40ca-8a71-5f92fd043668",function(data){
		alert(data);
	})*/
	$.getJSON("",function(data) {
		draw_gene_disease_network(data);
	});	
	$("#query_button").click(function(){
		var disease_query=$("#query_gene").val();
		$("#networkview").html("Loading Disease-Gene data...");
	$.getJSON("http://genewikiplus.org/api.php?action=ask&q=[["+disease_query+"]]&po=is+associated+with+disease&format=json&callback=?",function(data) {
		draw_gene_disease_network(data);
	});	
	});
	
	//draw_gene_disease_network(data);
	function draw_gene_disease_network(data)
	{
			var div_id = "networkview";
                var network_json = {
                        dataSchema: {
                    		nodes: [ { name: "label", type: "string" },
                    		{ name: "type", type: "string" },{ name: "category", type: "string" },{ name: "weight", type: "integer" }                   		      
           		         	],
							edges: [ { name: "label", type: "string" }						         
							]
                    	},
                        data: {
                            nodes: [ { id: "1", label: "1" },
                                     { id: "2", label: "2" }
                            ],
                            edges: [ { id: "2to1", target: "1", source: "2", label: "2 to 1" }
                            ]
                        }
                };
                var colorMapper = {attrName: "type",
        						   entries: [ { attrValue: "q", value: "#ff0000" },
                   							  { attrValue: "disease", value: "#00ff00" },
                   							  { attrValue: "category_group", value: "yellow" } ]
								  };
				
                var visual_style = {
                    global: {
                        backgroundColor: "#ABCFD6"
                    },
                    nodes: {
                        	color:{discreteMapper: colorMapper},
                        shape: { customMapper: { functionName: "customShape" }},
                        borderWidth: 3,
                        borderColor: "#ffffff",
                        labelFontSize : { customMapper: { functionName: "customSize" } },
                        size:"auto"
                       }
                     };
  
                network_json["data"]["nodes"]=[];
                network_json["data"]["edges"]=[];
                var counter=1;
                var edgecounter=1;
         
                network_json["data"]["nodes"].push({id:String(counter),label:data["ask"]["query"]["q"].replace("[[","").replace("]]",""),type:"q"});
                counter++;
                var secondary_centre;
                secondary_centre=counter-1;
                
                if(data["ask"]["results"]["items"][0]["properties"]["is_associated_with_disease"] instanceof Array)
					{
					
	            	for(var temp_disease in data["ask"]["results"]["items"][0]["properties"]["is_associated_with_disease"])
                	{
                	network_json["data"]["nodes"].push({id:String(counter),label:data["ask"]["results"]["items"][0]["properties"]["is_associated_with_disease"][temp_disease],type:"disease"});
                	network_json["data"]["edges"].push({id:String(edgecounter),target:String(counter),source:String(secondary_centre)});
                	edgecounter++;
                	counter++;	
                	}
					}
					else
					{
	            	network_json["data"]["nodes"].push({id:String(counter),label:data["ask"]["results"]["items"][0]["properties"]["is_associated_with_disease"],type:"disease"});
                	network_json["data"]["edges"].push({id:String(edgecounter),target:String(counter),source:String(secondary_centre)});
                	edgecounter++;
                	counter++;	
    
					}
                	
                
                     var layout = {
  								  name:    "Radial",
    							  options: { radius:"150" }
									};              
                var options = {
                    swfPath: "swf/CytoscapeWeb",
                    flashInstallerPath: "swf/playerProductInstall"
                };
                
                 var counter_per_node=0;
                var counter_for_deletion=0;
                var repeated_node="";
                var unique_node="";
                for(var temp_node in network_json["data"]["nodes"])
                {
                	counter_per_node=0;
                	for(var temp_node2 in network_json["data"]["nodes"])
                	{
                		
                		if(network_json["data"]["nodes"][temp_node]["label"]==network_json["data"]["nodes"][temp_node2]["label"])
                		{
                			counter_per_node++;
                		}
                	}
                	counter_for_deletion=0;
                	
                	if(counter_per_node>1)
                	{
                		
                		repeated_node=network_json["data"]["nodes"][temp_node]["id"];
                		
                		for(var delete_temp in network_json["data"]["nodes"])
                		{
                			
                			if(typeof network_json["data"]["nodes"][delete_temp]["id"] === "undefined")
                			{
                				
                			}	
                			else
                			{                			
                			if(network_json["data"]["nodes"][delete_temp]["label"]==network_json["data"]["nodes"][temp_node]["label"])
                			{
                			counter_for_deletion++;	                			
                			if(counter_for_deletion>1)
                			{
                				//delete [delete_temp]["label"]="To be deleted";
                				for(var delete_edge in network_json["data"]["edges"])
                				{            					
                					if(network_json["data"]["nodes"][delete_temp]["id"]==network_json["data"]["edges"][delete_edge]["target"])
                					{
                						network_json["data"]["edges"][delete_edge]["target"]=repeated_node;
                					}
                				}
                				network_json["data"]["nodes"].splice(delete_temp, 1);	                				
                			}
                			
                			}
                			}	
                		}
                		
                	}
                	
                }
                $("#networkview").html("Loading Disease category data...");
                var all_categories_array=[];
                var ajax_nodeids=new Array;
                var ajax_nodelabels=new Array;
                var ajax_nodelabels_count=0;
                var ajax_nodecount=-1;
                var disease_count=0;
                var data_storage=[];
                var data_storage_count=-1;
                inner_label_count=0;
                for(var temp in network_json["data"]["nodes"])
                {
                	if(network_json["data"]["nodes"][temp]["type"]=="disease")
                	{
                		disease_count++;
                	}
                }
                for(var temp in network_json["data"]["nodes"])
                {
                	
                	if(network_json["data"]["nodes"][temp]["type"]=="disease")
                	{
                		ajax_nodeids.push(network_json["data"]["nodes"][temp]["id"]);
                		ajax_nodelabels.push(network_json["data"]["nodes"][temp]["label"]);
                		ajax_nodelabels_count++;
                		$.getJSON("http://genewikiplus.org/api.php?action=query&titles="+ajax_nodelabels[ajax_nodelabels_count-1].replace(" ","+")+"&prop=categories&format=json&callback=?", function(data) {
							data_storage.push(data);
									ajax_nodecount++;
									data_storage_count++;							
							if(ajax_nodecount==disease_count-1)
							{								
								group_nodecategories();
							}
						});
                	}
                }
                var group_category=[];
    
                function group_nodecategories()
                {
                		for(var temp_nj in network_json["data"]["nodes"])
                		{
                			for(var data_storage_count in data_storage)
                	{
									for(var temp3 in data_storage[data_storage_count]["query"]["pages"])
									{
										if(data_storage[data_storage_count]["query"]["pages"][temp3]["title"]==network_json["data"]["nodes"][temp_nj]["label"])
								{
										for(var temp2 in data_storage[data_storage_count]["query"]["pages"][temp3]["categories"])
										{
										if((data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"].indexOf("articles")==-1)&&(data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"].indexOf("Articles")==-1)&&(data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"].indexOf("Wikipedia")==-1)&&(data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"].indexOf("Pages")==-1)&&(data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"].indexOf("pages")==-1)&&(data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"].indexOf("2010")==-1)/*&&(data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"].indexOf("Greek")==-1)*/)
										{
											all_categories_array.push({"category":data_storage[data_storage_count]["query"]["pages"][temp3]["categories"][temp2]["title"],"node_disease_id":network_json["data"]["nodes"][temp_nj]["id"],"node_disease_label":network_json["data"]["nodes"][temp_nj]["label"]});
										}
									}
								}			
						}
                				
                	}
                		
              	}
				
                var groupno=0;
                var group_flag=0;
                var group_category_index=0;
                for(var temp in all_categories_array)
                {
                	group_flag=0;
                	count_check=0;
                	for(var group_temp in group_category)
                	{
                		if(group_category[group_temp]["group_category"]==all_categories_array[temp]["category"])
                		{
                			group_flag=1;
                			group_category_index=group_temp;
                		}
                	}
                		
                	if(group_flag==0)
                	{
                	group_category.push({"group_no":groupno,"group_category":all_categories_array[temp]["category"],"ids":[]});
                	groupno++;
                	
                	for(var temp2 in all_categories_array)
					{
						if((all_categories_array[temp2]["category"]==group_category[group_category.length-1]["group_category"]))
						{
								group_category[group_category.length-1]["ids"].push(all_categories_array[temp2]["node_disease_id"]);
						}
					}
					}
                }
                /*
                To display grouped categories.
                for(var temp in group_category)
                {
                	$("#content").append("<br /><br />-------<br />Group No: "+group_category[temp]["group_no"]+"<br />Group Category: "+group_category[temp]["group_category"]+"<br />Id s are");
                	for(var temp_internal in group_category[temp]["ids"])
                	{
                		$("#content").append(group_category[temp]["ids"][temp_internal]+" ");
                	}
                }*/
                var to_filter=[];
                var to_remove=[];
                to_filter.push("1");
                var filter_flag=0;
                var count_category=0;
                var link_break=0;
                var filter_flag=0;
                for(var temp_main in network_json["data"]["nodes"])
                {
                	
                	for(var temp in group_category)
                {
                	count_category=0;
                	
                	for(var temp2 in group_category[temp]["ids"])
                	{
                		count_category=group_category[temp]["ids"].length;
                		
                			if(group_category[temp]["ids"][temp2]==network_json["data"]["nodes"][temp_main]["id"])
                		{
                			if(count_category==1)
                			{
                				network_json["data"]["nodes"][temp_main]["label"]+="\n"+group_category[temp]["group_category"];
                				filter_flag=0;
                				for(var temp_filter in to_filter)
                				{
                					if(to_filter[temp_filter]==group_category[temp]["ids"][temp2])
                					{
                						filter_flag=1;
                					}
                				}
                				if(filter_flag==0)
                				{
                				to_filter.push(network_json["data"]["nodes"][temp_main]["id"]);	
                				}                				
				 			}
                			else if(count_category>1)
                			{
                				
                				if(temp2==0)
                				{
                				network_json["data"]["nodes"].push({id:String(counter),label:group_category[temp]["group_category"]+"\nDiseases("+count_category+")",type:"category_group",weight:count_category});
                				network_json["data"]["edges"].push({id:String(edgecounter),source:"1",target:String(counter)});
                				to_filter.push(String(counter));                					
                				}
                				link_break=0;
                				for(var temp_edge in network_json["data"]["edges"])
                				{	
                				if((network_json["data"]["edges"][temp_edge]["target"]==network_json["data"]["nodes"][temp_main]["id"])&&(network_json["data"]["edges"][temp_edge]["source"]=="1"))
                				{
                					link_break=1;
                					network_json["data"]["edges"][temp_edge]["source"]=String(counter-temp2);
                					network_json["data"]["edges"][temp_edge]["target"]=network_json["data"]["nodes"][temp_main]["id"];
                				}
                				}
                				if(link_break==0)
                				{
									network_json["data"]["edges"].push({"id":String(edgecounter),"source":String(counter-temp2),"target":network_json["data"]["nodes"][temp_main]["id"]});
									edgecounter++;                					
                				}
                				if(temp2==0)
                				{
                					counter++;
                				edgecounter++;
                				}
                				to_remove.push(group_category[temp]["ids"][temp2]);
	
                			}
                		}	
                			
                	}
                }
                }
                for(var temp_filter in to_filter)
                				{
                					for(var temp_remove in to_remove)
                					{
                					if(to_filter[temp_filter]==to_remove[temp_remove])
                					{
                						to_filter.splice(temp_filter,1);
                					}	
                					}
                					
                				}
                                var vis = new org.cytoscapeweb.Visualization(div_id, options);
                global_vis=vis;
                 vis["customSize"] = function (data) {
    								   		var size = 11+Math.round(0.8*data["weight"]);
											return size;	
									   };
				vis["customShape"] = function (data) {
    								   if(data["type"]=="disease")
    								   {
    								   	return "ELLIPSE";
    								   }
    								   else if(data["type"]=="group_category")
    								   {
    								   	return "RECTANGLE";
    								   }
    								   else if(data["type"]=="q")
    								   {
    								   	return "HEXAGON";
    								   }
    								   else
    								   {
    								   	return "ROUNDRECT";
    								   }
    								   				
									   };
                vis.draw({ network: network_json, visualStyle: visual_style, layout:layout });	
                vis.ready(function(){
					vis.filter("nodes",to_filter);
					vis.addListener("click", "nodes",function(evt){
                 			var node=evt.target;
                 			if(node.data.type=="category_group")
                 			{
                 			var all_edges=vis.edges();
                 			for(var temp in all_edges)
                 			{
                 				if(all_edges[temp].data.source==node.data.id)
                 				{				
                						to_filter.push(all_edges[temp].data.target);				
                 				}
                 			}
                 			vis.filter("nodes",to_filter);	
                 			}
                 		});
				});
                }
                
                
	}
	
});
	